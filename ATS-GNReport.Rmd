---
title: 'Change in Fish Composition: Williston ATS GN surveys'
author: "Kristen Peck"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  word_document:
    toc: yes
    toc_depth: '2'
  html_document:
    toc: yes
    number_sections: yes
    toc_depth: 2
fig_caption: yes
always_allow_html: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(readxl)
library(sf)
library(mapview)

source("ATS2021.R")

```

# Methods

## 2000 survey (Pillipow and Langston, 2002)

The 2000 gillnet survey occurred from 24 August to 3 September 2000, concurrent with the Acoustic-Trawl survey (26 to 31 August) and is described in Pillipow and Langston (2002). At each of the seven stations (Factor Ross, Teare Creek, Finlay Junction, Clearwater Creek, Forebay, Blackwater Creek, and Heather Point) three nets were set at the surface parallel to shore and end-to-end with 50 to 100 m between the end and start of the next net. The nets were set in approximately the deepest part of the channel. Each net was composed of six 2.4 m deep by 15.2 m long monfilament stretched mesh panels of 25, 38, 51, 64, 76 and 89 mm, for a total net length of 91.2 m (hereafter referred to as RIC6; RISC 1997). Sets at each station were approximately 24 hours, starting around midday and pulled at around midday the following day. Catch was recorded both by net and by net panel but only total catch per panel (i.e. with no associated individual fork length) was available. A note was made in the appendix of the report that there may have been counting or recording errors made by the field crew at the Forebay station, but it was unclear what these were. Otherwise, there were no reported gear or sampling equipment malfunctions and little delay between net sets. Age data was obtained through the collection of otoliths for Lake Whitefish and Bull Trout, and scale samples for Kokanee. Sebastian et al. (2003) compared the 2000, 1988 and 1974/75 gillnet methods and catch in detail. They considered the 2000 survey a reconnaissance level of effort.

## 2008 GN survey (Sebastian et al. 2009)

Gill netting in the 2008 survey occurred from 15-18 July only at three stations in the Peace Reach: the Forebay, Adams Creek and Nabesche (Sebastian et al. 2009). The earlier season timing of this survey was recommended in Sebastian et al. (2003) to help distinguish between Lake Whitefish and Kokanee, which they suggested may have slightly different temperature preferences and therefore be more easily distinguished in warmer water. The Forebay station was similar to the 2000 study and the Nabesche station was within 15 km of the Clearwater station from 2000, and Adams Creek is an additional location between these two. The gill net locations are therefore only representative of the eastern half of the Peace Reach. The Acoustic-Trawl survey occurred after the gill net survey (28 July to 1 August). 

The methods used in this survey intentionally mimicked the 2000 survey methods. At each station, three RIC6 gill nets were set parallel to shore in the deepest part of the channel, just below the surface and with a 100 m gap between the end of one net and the beginning of the next. Nets were set in the afternoon or evening and soaked overnight between 12 and 24 hours. Catch was recorded by net and station. Overall, there were no reported gear or sampling equipment malfunctions and little delay between net sets.  Age data was obtained through the collection of otoliths for Lake Whitefish and Bull Trout, and scale samples for Kokanee and Rainbow Trout.

## 2021 GN survey (O’Connor 2022)

This gill net survey followed the depth-stratified methods used in Kinbasket and Revelstoke Reservoirs (Sebastian and Weir 2016) rather than surface-only sets, but had only one replicate at each station. Four RIC6 or RIC7 nets were set in continuous 5 m depth increments from top-of-the-net depths of 5 to 20 m (see O’Connor 2022 for diagram). Only five of seven stations were sampled effectively enough to be used: Teare Creek, Finlay Forks, Clearwater Creek, Blackwater Creek, and Heather Point, while Factor Ross and the Forebay were ineffective or omitted due to time constraints. The Teare Creek set was affected by windy conditions. The gill net survey ran from 3 August to 15 August but was not continuous due to equipment malfunctions. It overlapped the Acoustic-Trawl survey timing (2 to 14 August).

At each of the five stations, four 6- or 7-panel sinking RIC nets were set at depths from 5 m to 20 m (RIC6 mesh sizes 25, 38, 51, 64, 76, 89 mm and the RIC7 nets included an additional panel of 32 mm). The use of 6 versus 7 panel RIC nets was noted occasionally (e.g. at the Blackwater station 20 m depth and Heather Point 5 m depth) but perhaps not consistently at all stations; in cases with no specific mention, RIC7 nets were assumed. An additional two RIC7 nets were set at Teare Creek to cover the full 0 and 25 m strata (for a concurrent project, not reported on here), but the deepest 25 m net was ripped on retrieval and the 0 m net was ineffective since it curled in on itself sometime within the set due to a storm. At Heather Point, the 0 m stratum was sampled but not the 20 m stratum due to a higher fish layer observed in the Parsnip Reach. One large hole was reported in the net at the 5 m stratum at the Blackwater Station, but it is unclear whether this net was changed out or continued to be used throughout the rest of the survey. Fish weight was measured only to the nearest 5 g, making the weights for small fish too imprecise to use, though large fish weights (>300 g) were likely precise enough to be useful. Catch was recorded by net and station. Age information was obtained from otoliths collected from Kokanee, Lake Whitefish, Bull Trout and Lake Trout. 

## Data organization and analysis:
Information from net sets with issues (2021: Forebay station, Teare Creek depths 0 and 25 m) were removed from any catch per unit effort comparisons, but the fish measurement information was retained where possible for comparisons of length, weight or length at age comparisons. Gill net and Trawl results from each of the three years were reorganized to match column names and values in Microsoft Excel.

Where applicable, species and maturity codes follow BC Provincial standards (FIDQ 2023, RISC 1997). Analyses were conducted in R version 4.2.2 (R Core Team 2022). Packages tidyverse (Wickham et al. 2019), readxl (Wickham and Bryan 2022), lubridate (Grolemund and Wickham 2011) were used to load and organize data and other R packages are identified below for each analysis. RMarkdown (Allaire et al. 2023) and knitr (Xie 2023) were used to render some tables, text and figures.

## Investigating change in species composition

### Catch per unit effort for gill nets: 

Individual net dimensions were equivalent among years except that in 2021 most nets had an extra 32 mm panel targeting the 130 to 160 mm fork length. To compare the catch per unit effort (CPUE) among years, we removed that size range for all years and net types. Set and pull times were taken from the data on file and reports from previous years and may include inaccuracies (e.g. the mirrored set and pull times for nets 2 and 3 at Forebay station in 2008). CPUE is reported as catch per net and per hour of soak time (per net-hour).

Because the methods among years differed by depth of gill net, CPUE comparisons among years were limited catch from net depths of 10 m and above, which was consistently above the thermocline during all sampling events. This excluded nets set at depths of 15 and 20 m in 2021 at all stations. Stations were limited to locations that were sampled in more than one year, which limited comparison to Teare Creek for the Finlay Reach (2000 and 2021), Finlay Forks at the Junction (2000 and 2021), Blackwater and Heather Point for the Parsnip Reach (2000 and 2021), Clearwater/Nabesche (2000, 2008 and 2021) and Forebay (2000 and 2008) for the Peace Reach. Clearwater (2000 and 2021) and Nabesche (2008) were considered equivalent in the CPUE comparison since the sites were within 15 km of each other. Linear regressions of Kokanee and Lake Whitefish CPUE with year, and interactions between year and station to see if there has been a detectable trend over time, and if that trend has differed by station. 

### Fish condition and length-at-age

Kokanee and Lake Whitefish condition (length-weight relationship) and length-at-age was compared between surveys and among reservoir reaches. The weight measurements from the gill net-caught fish in 2021 were too imprecise and appear biased (`r paste0("n= ",nrow(GNTR.predwts))`; uncalibrated spring scales) and were discarded. However, the trawl-caught fish (`r paste0("n= ",nrow(GNTR.measuredwts))`) were measured with higher precision and accuracy so those fish were comparable to previous years. The majority of trawl-caught fish were Kokanee, so the comparisons of length-weight and condition factor among years was limited to that species.

Length-at-age among years was also compared where possible, but no age data was available for the 2021 report (expected late March 2023). An Age-Length Key was constructed using 10 mm bins, fit to multinomial models using nnet (Venables and Ripley 2002) and compared using an ANOVA as described in Ogle (2016). In cases where only a subset of the range of fork lengths was aged within a year and species, ages were predicted from the remaining fork lengths using the Age-Length Key following Isermann and Knight (2005). Von Bertalanffy growth curve statistics were estimated for each year and species. 

Unfortunately, Kokanee and Lake Whitefish ages from the gill netting in 2000 were discarded due to their questionable age results (`r paste0("n=",nrow(fish.GN00[fish.GN00$Species %in% "LW" & !is.na(fish.GN00$Age),])," LW")` and `r paste0("n=",nrow(fish.GN00[fish.GN00$Species %in% "KO" & !is.na(fish.GN00$Age),])," KO")`) as noted in Sebastian et al. (2003). There remains only `r paste0("n=",nrow(fish.TR00[fish.TR00$SPEC %in% "LW" & !is.na(fish.TR00$AGE),])," LW")`and `r paste0("n=",nrow(fish.TR00[fish.TR00$SPEC %in% "KO" & !is.na(fish.TR00$AGE),])," KO")` from trawl-caught fish for 2000. In 2008, only gill nets were used so the smaller sizes and ages were not sampled. 




# Results

## Gillnetting locations (interactive map)

```{r GN map, echo=F,fig.cap="Map of the starting point of gillnet locations by year. "}
GN.map
```

## Summary of gillnet sets per year

```{r effort summary, echo=F, warning=F, message=F}
knitr::kable(efforts.per.year)
```


## GN CPUE - Making the Data Comparable

First need to make sites and net catch comparable by making site names equivalent (i.e. Nabesche [2008] is close enough to Clearwater [2000&2021]; Adams Creek is a site not used outside of 2008), examine and remove the extra panel from the RIC7 nets used in 2021.

**how many fish removed?

Examine whether RIC6 nets caught fish in 130:160mm FL range:

```{r RIC6 130 to 160mm ,echo=F, warning=F, message=F}

knitr::kable(RIC6.fish)
RIC6plot


```

And how many in th 130-160 mm range were caught by RIC7s (which were only used in 2021):

```{r RIC7 130 to 160mm ,echo=F, warning=F, message=F}

knitr::kable(RIC7.fish)
RIC7plot

```

Given the greater catch of this size range in the RIC7s (as expected) we will remove this size range from both RIC6 and RIC7 for CPUE comparisons.

### Kokanee and Lake Whitefish CPUE
Kokanee and Lake Whitefish are likely the only two species that should be compared for CPUE (and note-only WITHIN species) since the rest are either two low density (the predators) or they seem to swim in schools (Peamouth).

After the extra panel target size is removed and the sites are more or less made equivalent, we still have the problem that different depths were set each year - surface sets only for 2000 and 2008 and mostly 5 - 20 m depth for 2021. What this looks like when looking at CPUE by depth for Kokanee and Lake Whitefish:

```{r CPUE by depth KO,echo=F, warning=F, message=F, fig.cap="CPUE (catch per net hour) by site, net depth and year for Kokanee."}
CPUEKOplot
```

```{r CPUE by depth LW ,echo=F, warning=F, message=F, fig.cap="CPUE (catch per net hour) by site, net depth and year for Lake Whitefish"}
CPUELWplot
```

We see that there are not many cases of equivalency between years, where the same depths and sites were sampled. We can perhaps assume the 0-10 m net depths (above the thermocline in every year) are comparable, in which case the average CPUE for Kokanee and Lake Whitefish are:

```{r CPUE above 10 m,echo=F, warning=F, message=F}

knitr::kable(table.cpue.stats, digits=2,col.names = c("Reach", "Station","Year","# Nets",
                                                      "Mean Soak Time (hrs)","Mean KO",
                                                      "StDev KO", "Mean LW",
                                                      "StDev LW"))

```

If we pick only the sites with more than one year of netting data (Teare Creek, Finlay Forks, Blackwater, Heather Point, Clearwater/Nabesche, Forebay) and compare the CPUE over time:

```{r CPUE select sites, echo=F, warning=F, message=F, fig.cap="Mean CPUE (+/-95CI) for Kokanee (in purple) and Lake Whitefish (in blue) among years. Only sites with more than one year of sampling is shown. NOTE that each species should only be interpreted alone, not relative to the other species due to likely differences in vulnerability to the gillnets."}
plot.cpue.KO
plot.cpue.LW
```

## GN CPUE - Kokanee and Lake Whitefish over time

We can check if there has been an overall trend in CPUE over the years sampled for Kokanee: 

```{r LM KO,echo=F, warning=F, message=F}
summary(lm.KOyr)
```

And for Lake Whitefish:

```{r LM LW,echo=F, warning=F, message=F}
summary(lm.LWyr)
```

An AIC comparison of models with year only, year * Reach and year * Site showed that the most parsimonious model with the year effect alone for both species.


## Changes in fish condition

The assumptions behind these comparisons are that the methods used among years are comparable - i.e. that measurements were taking without error in each year and a sufficient sample was measured to cover the range of captured fish. This assumption, we suspect, was violated in the gill netting data in 2021 since the tools used to obtain weights were too coarse (hanging pesola scales, non-calibrated). We need to spend some time making the data comparable before proceeding:

```{r length-weight KO by year, echo=F,warning=F, message=F, fig.cap="Kokanee length-weight measurements by year collected with gillnet (GN) and trawl (TR). Note that there was no trawling in 2008."}
plotlength.weight.rawKO

```

We can see in the above plot that there is a much wider spread of Kokanee weights in the 2021 GN measurements and they are all slightly above previous years of catch, as well as some obvious outliers. This may be demonstrating a real change in the fish condition, except that if we compare to the trawl data from the same survey:

```{r length-weight KO by method, echo=F,warning=F, message=F}
plotlength.weightKO.2021
```

So unfortunately the Kokanee weights from the gill netting (`r paste0("n= ",nrow(GNTR.predwts))`) should be discarded entirely, since they are both inaccurate and imprecise. However, there is a large overlap in fork length sizes from the trawl catches of Kokanee (`r paste0("n= ",nrow(GNTR.measuredwts))`) in 2021, so the weights and individual weight error intervals can be predicted from the fork lengths following Ogle (2016):

```{r predicted weights, echo=F, warning=F, message=F}
plotpred.weightKO.2021
```

This can only be done for Kokanee since no other species was caught in great enough numbers in the trawl in 2021. A big assumption here is that the gear (gillnet vs trawl net) are collecting the same fish of the same fork length (e.g. gill net fish are not fatter or skinnier than trawl fish). We can see from the 2000 concurrent gillnet and trawl measurements for Kokanee that the Kokanee sizes overlap, so the assumption that the two methods select for the same condition of fish is met (though would be great to look at other water bodies with a bigger sample size - Kinbasket??). Note that the predicted fork lengths and weights exceed the measured lengths and weights so these should be interpreted with caution.

```{r compare methods, echo=F,warning=F, message=F}
plot.compare.methods

```

I am still pondering whether it is reasonable to use these predicted weights in a statistical comparison among years since they would underestimate the error, so for now I will leave them out, or point it out if I do use them. 

```{r KO weight-length, echo=F, warning=F, message=F}
plot.FLwtbyyear
paste("lm(logwt~logFL*yearF")
car::Anova(fit1.ko)
```

Though the plot of Kokanee length-weight above does not look like it is showing a difference between years, the overall ANOVA identifies a statistical difference between years, and possibly a difference between the slope for at least one year and the others. One issue is that in 2000 and 2021 there were not that many age-0s measured, so there is some potential leverage on the small end of Kokanee. In 2008 this size range of Kokanee was not even sampled since there was no trawl. If we chop the comparison at fish 100 mm and larger we can see if those points were really affecting the ANOVA. For this comparison we can use the predicted weights and no predicted weights to see how they differ.

```{r KO weigth-length 100mm predicted, echo=F, warning=F, message=F}
plot.FLwtbyyearbigpred
car::Anova(fit2.ko)
```

```{r KO weigth-length 100mm, echo=F,warning=F, message=F}
plot.FLwtbyyearbignopred
car::Anova(fit3.ko)
```

We can see that the inclusion of the gillnetted predicted weights is pretty key to whether or not there is a change in Kokanee condition as fish get larger in 2021 (compared to 2000 and 2008 which have parallel slopes) but it appears that Kokanee are in a better condition across all sizes in 2000 (ie.there is a small but consistent statistical year effect during all test). 

If you believe that the gill net fish Fork Lengths were measured without bias and that the predicted relationship between trawled fork length and weight holds for larger Kokanee, then it is possible that the abundant age 1 fish from 2021 have a lower condition due to density dependence and the larger fish are free of that. This is just a snapshot of the fish assemblage in a single year, so it is hard to know if this pattern would move through with the cohort, or if it is now a pattern every year. Next we can take a closer look at the condition factor at age using Fulton's K(using measured weights only).

*NOTE:* need to do this for LW still.

## Fulton's K

```{r KO K freq, echo=F,warning=F, message=F}
plot.Kbyagehistogram
```

Some things to point out in the above histogram: 2000 has some very complex age structure and suspiciously old Kokanee (perhaps mis-ID'd rainbows?); 2008 had no trawls so the age 0 component is absent, which generally have a lower condition factor than the older ages in 2000 and 2021; 2021 had a dominant age 1 component (though ages are still preliminary) while 2008 had more 2s and 3s in the gillnet catch.

Here is another way to look at this by plotting Fulton's K at each (jittered) age with a loess curve (note 2021 ages are still preliminary):

```{r KO K by age, echo=F, warning=F, message=F, fig.cap="Fulton's condition factor for Kokanee caught each year by the age they were classified into."}
plot.Kagebyyear
```

2008 condition factor sits below the 2000 and 2021 Kokanee but there was only sampling in the Peace Reach, so we will look at patterns across the reaches.

```{r KO K by age and reach, echo=F, warning=F, message=F}
plot.Kagebyyear.reach
```

We can see that the pattern of 2008 having a lower K at age still holds even when only comparing within the Peace Reach. 

## Length at age

The ages from 2021 are still unavailable except for predicted ages of Kokanee based on size breaks. Looking back at 2000 and 2008 we can see if it is worth extrapolating ages using an age-length key where only a subset of measured fish were aged. 

```{r number aged by sp, echo=F, warning=F, message=F}
knitr::kable(aged,col.names = c("Year","Species","Total Caught","Aged"),align = "l")

```

It looks like the only species and year that would benefit from estimating ages from the fork length is Lake Whitefish in 2000, where the entire range of fork lengths were subsampled for aging (not shown). I will use the Age-Length Key (ALK) method from Ogle (2016) to estimate the ages of Lake Whitefish measured for fork length but not aged. I will combine these will measured ages from now on for Lake Whitefish in 2000. 

```{r LW ALK sizes, echo=F, warning=F, message=F}
LW.ALKpredict
```

We can then compare whether ages over the years have changed using a multinomial analysis described in Ogle (2016). Fork Lengths were categorized into 10 mm categories and compared to the age in an Age-Length Key. For Kokanee we can do this for all years (though the 2021 ages are still preliminary) but there are no ages available for 2021 yet for Lake Whitefish so the statistical comparison is only between 2000 and 2008.

Difference in ALK for Kokanee between 2000, 2008, and 2021 (prelim ages):

```{r diffs among years ALK KO, echo=F, warning=F, message=F}
paste("KO: comparing age~lcat10 and age~lcat10*yearF :")
anova(mod1KO,mod2KO)
```

Difference in ALK for Lake Whitefish between 2000 and 2008:

```{r diffs among years ALK LW, echo=F, warning=F, message=F}
paste("LW: comparing age~lcat10 and age~lcat10*yearF :")
anova(mod1LW,mod2LW)

```

The above tests say that there is a statistical difference between years (2000, 2008, and 2021) in the age-length key for Kokanee, but no difference in the age-length key between 2000 and 2008 for Lake Whitefish.

We can visualize the Von Bertalanffy growth functions of each year to see if we can spot the change over time in the mean length-at-age for each species. According to the ALK multinomial test, there was no statistical difference between 2000 and 2008 for Lake Whitefish and we can see that there are only visible differences at the extreme ages:

```{r Von bert for LW, echo=F, warning=F, message=F, fig.cap="Von Bertalanffy growth curves for Lake Whitefish. The equations are showing the VB growth function parameters for each year, including Linf, k and L0."}

LWages.plot

```

According to the ALK test above for Kokanee, there was a statistical difference among years. This is what it looks like in a mean length-at-age curve:

```{r Von bert for KO, echo=F, warnings=F, message=F,fig.cap="Von Bertalanffy growth curves for Kokanee. The equations are showing the VB growth function parameters for each year, including Linf, k and L0."}
KOages.plot
```

Again we see that funky age old age structure for 2000, and the lack of small KO (due to lack of trawl) in 2008. However, the Linfinity has been potentially decreasing through the years? Will have to re-do once the age data are fixed.
